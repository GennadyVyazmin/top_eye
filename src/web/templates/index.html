<!-- src/web/templates/index.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í–∏–¥–µ–æ–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ - –°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π –∑–∞–ª</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            display: flex;
            gap: 20px;
            max-width: 1800px;
            margin: 0 auto;
        }
        .video-container {
            flex: 3;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stats-container {
            flex: 1;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .faces-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        .face-card {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            text-align: center;
        }
        .face-card img {
            max-width: 100%;
            border-radius: 4px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        #video {
            width: 100%;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="video-container">
            <h2>–í–∏–¥–µ–æ —Å –∫–∞–º–µ—Ä—ã</h2>
            <img id="video" alt="–í–∏–¥–µ–æ–ø–æ—Ç–æ–∫">

            <h3>–õ—é–¥–∏ –≤ –∫–∞–¥—Ä–µ</h3>
            <div id="faces" class="faces-container">
                <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –ª–∏—Ü–∞ -->
            </div>
        </div>

        <div class="stats-container">
            <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>

            <div class="stat-card">
                <h3>–°–µ–π—á–∞—Å –≤ –∫–∞–¥—Ä–µ</h3>
                <p id="currentCount" class="stat-number">0</p>
            </div>

            <div class="stat-card">
                <h3>–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å–µ–≥–æ–¥–Ω—è</h3>
                <p id="todayUnique" class="stat-number">0</p>
            </div>

            <div class="stat-card">
                <h3>–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</h3>
                <p id="sessionUnique" class="stat-number">0</p>
            </div>

            <h3>–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
            <div id="historyStats">
                <!-- –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ API -->
            </div>

            <button onclick="downloadStats()" style="margin-top: 20px; padding: 10px 20px;">
                üì• –°–∫–∞—á–∞—Ç—å –ø–æ–ª–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            </button>
        </div>
    </div>

    <script>
        // WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–ª—è –≤–∏–¥–µ–æ
        const videoSocket = new WebSocket(`ws://${window.location.host}/ws/video`);

        videoSocket.onmessage = function(event) {
            const data = JSON.parse(event.data);

            if (data.type === 'frame') {
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–¥–µ–æ
                document.getElementById('video').src =
                    'data:image/jpeg;base64,' + data.frame;

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                document.getElementById('currentCount').textContent =
                    data.current_count;
                document.getElementById('todayUnique').textContent =
                    data.today_unique;
                document.getElementById('sessionUnique').textContent =
                    data.session_unique;

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–∏—Ü –≤ –∫–∞–¥—Ä–µ
                updateFacesDisplay(data.faces || []);
            }
        };

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        async function loadHistoricalStats() {
            const response = await fetch('/api/stats');
            const stats = await response.json();

            const container = document.getElementById('historyStats');
            container.innerHTML = '';

            for (const [period, data] of Object.entries(stats)) {
                const statDiv = document.createElement('div');
                statDiv.className = 'stat-card';
                statDiv.innerHTML = `
                    <h4>${period}</h4>
                    <p>–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö: ${data.unique_visitors || 0}</p>
                    <p>–í—Å–µ–≥–æ –¥–µ—Ç–µ–∫—Ü–∏–π: ${data.total_detections || 0}</p>
                `;
                container.appendChild(statDiv);
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ª–∏—Ü
        function updateFacesDisplay(faces) {
            const container = document.getElementById('faces');
            container.innerHTML = '';

            faces.forEach(face => {
                const faceCard = document.createElement('div');
                faceCard.className = 'face-card';

                // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ª–∏—Ü–∞ –≤ base64
                const imgData = arrayBufferToBase64(face.face_image);

                faceCard.innerHTML = `
                    <img src="data:image/jpeg;base64,${imgData}"
                         alt="${face.identity}">
                    <p>${face.identity}</p>
                    <small>${new Date(face.timestamp).toLocaleTimeString()}</small>
                `;
                container.appendChild(faceCard);
            });
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }

        // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        async function downloadStats() {
            const response = await fetch('/api/stats/export');
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        setInterval(loadHistoricalStats, 30000);
        loadHistoricalStats(); // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
    </script>
</body>
</html>